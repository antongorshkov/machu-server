<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MV Directory</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">

    <!-- UIKit 3 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.16.26/dist/css/uikit.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.16.26/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.16.26/dist/js/uikit-icons.min.js"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    
    <!-- Custom CSS to override DataTables styling -->
    <style>
        /* Modal width styling */
        .uk-modal {
            z-index: 1010 !important; /* Ensure modal has proper z-index */
        }
        
        #add-entry-modal .uk-modal-dialog {
            width: 400px;
            max-width: 90%;
            box-sizing: border-box;
            margin: 0 auto;
        }
        
        @media (min-width: 640px) {
            #add-entry-modal .uk-modal-dialog {
                width: 400px;
                max-width: 400px;
            }
        }
        
        /* Override DataTables row background colors */
        table.dataTable tbody tr,
        table.dataTable tbody tr.odd,
        table.dataTable tbody tr.even {
            background-color: transparent !important;
        }
        
        /* Completely disable DataTables styling */
        table.dataTable.stripe tbody tr.odd,
        table.dataTable.display tbody tr.odd {
            background-color: transparent !important;
        }
        
        table.dataTable.stripe tbody tr.even,
        table.dataTable.display tbody tr.even {
            background-color: transparent !important;
        }
        
        /* Override any cell-specific styling */
        table.dataTable tbody td {
            background-color: inherit !important;
        }
        
        /* Set explicit background colors for all cells */
        table.dataTable tbody tr:nth-child(odd) td {
            background-color: #ffffff !important;
        }
        
        table.dataTable tbody tr:nth-child(even) td {
            background-color: #f5f5f5 !important;
        }
    </style>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <!-- jQuery & DataTables.js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <style>
        /* Import modern sans-serif font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* General Styling */
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            background-color: #f8f9fa;
            margin: 20px;
        }
        
        /* Force consistent row backgrounds - completely override DataTables styling */
        table.dataTable.stripe tbody tr.odd,
        table.dataTable.stripe tbody tr.odd td,
        table.dataTable tbody tr:nth-child(odd),
        table.dataTable tbody tr:nth-child(odd) td {
            background-color: #ffffff !important;
        }
        
        table.dataTable.stripe tbody tr.even,
        table.dataTable.stripe tbody tr.even td,
        table.dataTable tbody tr:nth-child(even),
        table.dataTable tbody tr:nth-child(even) td {
            background-color: #f5f5f5 !important;
        }
        
        .container {
            max-width: 100%;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    
        /* Ensure table cells have enough padding for readability */
        table.dataTable tbody tr {
            height: auto;
        }
        
        table.dataTable td {
            font-size: 16px;
            padding: 12px;
            word-break: break-word; /* Prevent text overflow */
        }
    
        /* Prevent Table Overflow on Small Screens */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        }
    
        /* ðŸ“Œ Improve category button layout */
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: flex-start;
            margin-bottom: 10px;
            padding-bottom: 0;
        }

        /* ðŸ“Œ Category buttons - more compact & uniform */
        .filter-buttons button {
            flex-grow: 0;
            flex-shrink: 0;
            min-width: 80px;
            padding: 5px 10px;
            font-size: 14px;
            text-align: center;
            border-radius: 16px;
            white-space: nowrap;
        }

        /* ðŸ“Œ Ensure table is scrollable & responsive */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            padding: 10px;
        }

        /* ðŸ“Œ Ensure table has proper column spacing */
        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
            margin-top: 4px !important;
        }

        /* Apply alternating colors to entire rows */
        table.dataTable tbody tr:nth-child(odd) {
            background-color: #ffffff !important;
        }
        
        table.dataTable tbody tr:nth-child(even) {
            background-color: #f5f5f5 !important;
        }

        /* ðŸ“Œ Adjust column widths */
        table.dataTable th:nth-child(1), /* Name Column */
        table.dataTable td:nth-child(1) {
            width: 25%;
            font-weight: bold;
        }

        table.dataTable th:nth-child(2), /* Category */
        table.dataTable td:nth-child(2) {
            width: 15%;
            text-align: center;
        }

        table.dataTable th:nth-child(3), /* Description */
        table.dataTable td:nth-child(3) {
            width: 40%;
        }

        table.dataTable th:nth-child(4), /* Phone Number */
        table.dataTable td:nth-child(4) {
            width: 20%;
            text-align: right;
            padding-right: 24px;
        }

        /* Phone number styling */
        .chat-phone {
            display: inline-flex;
            align-items: center;
            background: #e8f5e9;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 400;
            text-decoration: none;
            color: #1a1a1a;
            transition: all 0.2s ease;
        }
        
        /* Ensure edit button column is always visible */
        .never-hide {
            display: table-cell !important;
        }
        
        /* Better styling for edit button on mobile */
        @media (max-width: 767px) {
            .edit-btn {
                padding: 0 10px;
                min-height: 30px;
            }
            
            /* Make sure edit button stays visible */
            #directoryTable th:last-child,
            #directoryTable td:last-child {
                width: 40px !important;
                min-width: 40px !important;
                display: table-cell !important;
            }
        }

        .chat-phone:hover {
            background: #c8e6c9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(37,211,102,0.1);
            text-decoration: none;
            color: #1a1a1a;
        }

        .chat-phone i {
            color: #25D366;
            margin-right: 8px;
            font-size: 18px;
        }
        
        .chat-website {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 400;
            text-decoration: none;
            color: #1a1a1a;
            transition: all 0.2s ease;
        }
        
        .chat-website:hover {
            background: #bbdefb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(30,135,240,0.1);
            text-decoration: none;
            color: #1a1a1a;
        }
        
        .chat-website i {
            color: #1e87f0;
            margin-right: 8px;
            font-size: 18px;
        }

        /* ðŸ“Œ Improve row styling */
        table.dataTable tbody td {
            background-color: transparent !important;
        }

        table.dataTable tbody tr:hover {
            background-color: #f1f1f1 !important; /* Highlight on hover */
        }

        /* ðŸ“Œ Highlight search results */
        table.dataTable td.highlight {
            background-color: yellow !important;
            font-weight: bold;
        }

        /* ðŸ“Œ Selected category button style */
        .uk-button {
            border-radius: 16px;
            padding: 0 10px;
            font-size: 13px;
            text-transform: capitalize;
            transition: all 0.2s ease;
            background: #1e87f0;
            border: 1px solid #1e87f0;
            color: white;
            margin: 0 1px;
            height: 26px;
            line-height: 24px;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .uk-button:hover {
            background: #0f7ae5;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(30,135,240,0.2);
        }

        .uk-button.uk-button-primary {
            background-color: #32d296 !important;
            color: white !important;
            border-color: #32d296 !important;
            box-shadow: 0 2px 4px rgba(50,210,150,0.2);
            font-weight: 500;
        }
        /* Desktop/Mobile View Toggle */
        .table-view { 
            display: block; 
        }

        /* Table styling improvements */
        table.dataTable {
            border-collapse: collapse;
            border-spacing: 0;
            margin: 0 !important;
            width: 100%;
        }

        table.dataTable thead th {
            border-bottom: 1px solid #e5e5e5;
            padding: 4px 20px;
            font-weight: 500;
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: transparent;
        }

        table.dataTable tbody td {
            padding: 8px 20px;
            vertical-align: middle;
            border: none;
            border-bottom: 1px solid #e5e5e5;
            transition: all 0.2s ease;
            line-height: 1.3;
            font-size: 14px;
            color: #333;
            background: none !important;
        }

        table.dataTable tbody td:first-child {
            border-left: 1px solid #e5e5e5;
        }

        table.dataTable tbody td:last-child {
            border-right: 1px solid #e5e5e5;
        }

        table.dataTable tbody tr:hover td {
            background-color: #e9f0f7 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
        }

        table.dataTable tbody tr td:first-child {
            font-weight: 500;
            color: #1a1a1a;
        }
        .whatsapp-view { display: none !important; }

        /* WhatsApp button styling for both mobile and desktop */
        .chat-phone {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            background: #e8f5e9;
            text-decoration: none;
            color: #000;
            width: fit-content;
            font-size: 14px;
            line-height: 1.2;
        }

        .chat-phone i {
            color: #25D366;
            margin-right: 6px;
            font-size: 16px;
        }

        .chat-phone span {
            color: #000;
            font-weight: 400;
        }

        /* RESPONSIVE LAYOUT */
        @media (max-width: 768px) {
            .table-view { display: none !important; }
            .whatsapp-view { 
                display: block !important;
                margin-top: 20px;
            }

            .filter-buttons {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin: 16px 0;
            }

            .filter-buttons button {
                width: 100%;
                min-width: 0;
                padding: 8px;
                font-size: 13px;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Chat List Styling */
            .chat-list {
                background: white;
                border-radius: 8px;
                margin-top: 16px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .chat-item {
                display: flex;
                align-items: flex-start;
                padding: 16px;
                border-bottom: 1px solid #e5e5e5;
                text-decoration: none;
                color: inherit;
                background: white;
                transition: background-color 0.2s;
            }

            .chat-item:last-child {
                border-bottom: none;
                border-radius: 0 0 8px 8px;
            }

            .chat-item:first-child {
                border-radius: 8px 8px 0 0;
            }

            .chat-item:active {
                background-color: #f5f5f5;
            }

            .chat-avatar {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                margin-right: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
                font-size: 17px;
                flex-shrink: 0;
                letter-spacing: -0.2px;
            }

            .chat-content {
                flex-grow: 1;
                min-width: 0;
            }

            .chat-title {
                font-weight: bold;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .chat-category {
                display: inline-block;
                font-size: 12px;
                padding: 2px 8px;
                border-radius: 12px;
                background: #e8f5e9;
                color: #1b5e20;
                margin-bottom: 4px;
            }

            .chat-preview {
                color: #666;
                font-size: 14px;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }



            /* Mobile-specific margin */
            @media (max-width: 768px) {
                .chat-phone {
                    margin-top: 8px;
                }
            }

            .chat-phone:active {
                background: #c8e6c9;
            }

            .chat-phone i {
                margin-right: 6px;
                color: #25D366;
            }

            /* If category count is odd, center last button */
            .filter-buttons button:nth-child(odd):last-child {
                width: 100%;
            }

            /* ðŸ“Œ Ensure table text is readable on mobile */
            table.dataTable {
                width: 100% !important;
                border-collapse: collapse;
                font-size: 14px; /* Slightly smaller for mobile */
            }

            /* ðŸ“Œ Adjust column widths for better readability */
            table.dataTable td, table.dataTable th {
                padding: 10px 8px; /* Less padding */
                white-space: nowrap; /* Prevents awkward text wrapping */
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* ðŸ“Œ Ensure name & category don't break badly */
            table.dataTable td:nth-child(1), /* Name */
            table.dataTable td:nth-child(2) { /* Category */
                max-width: 30%; 
            }

            /* ðŸ“Œ Mobile WhatsApp-style view */
            .table-container {
                display: none; /* Hide table on mobile */
            }

            .whatsapp-view {
                display: none; /* Hidden by default, shown on mobile */
            }

            .chat-list {
                margin: 0 -16px;
                padding: 8px 16px;
                background: #fff;
            }

            .chat-item {
                display: flex;
                align-items: flex-start;
                padding: 12px 0;
                border-bottom: 1px solid #e5e5e5;
                text-decoration: none;
                color: inherit;
                width: 100%;
                position: relative;
            }

            .chat-avatar {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                margin-right: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
                font-size: 17px;
                flex-shrink: 0;
                letter-spacing: -0.2px;
            }

            .chat-content {
                flex-grow: 1;
                min-width: 0; /* Enable text truncation */
                width: 100%; /* Use full width */
                box-sizing: border-box;
            }

            .chat-title {
                font-weight: bold;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .chat-category {
                display: inline-block;
                font-size: 12px;
                padding: 2px 8px;
                border-radius: 12px;
                background: #e8f5e9;
                color: #1b5e20;
                margin-bottom: 4px;
            }

            .chat-preview {
                color: #666;
                font-size: 14px;
                /* Remove line clamp to show full description */
                display: block;
                white-space: normal;
                overflow: visible;
                word-wrap: break-word;
                line-height: 1.4;
                margin-bottom: 8px;
                width: 100%;
                box-sizing: border-box;
                padding-right: 0;
            }

            .chat-phone {
                color: #075e54; /* WhatsApp green */
                font-weight: 500;
                margin-top: 4px;
                display: block;
            }
        }
    </style>    
</head>
<body>
    <!-- Hidden server configuration data -->
    <div id="server-config" class="uk-hidden" 
         data-use-cache="{{ 'true' if use_cache else 'false' }}"
         data-airtable-token="{{ airtable_token }}"
         data-airtable-base-id="{{ airtable_base_id }}"
         data-airtable-table-name="{{ airtable_table_name }}"></div>

    <div class="uk-container uk-margin-large-top uk-card uk-card-default uk-card-body uk-box-shadow-small" style="max-width: 1000px; padding: 20px;">
        <div class="uk-flex uk-flex-between uk-flex-middle">
            <h2 class="uk-heading-line uk-text-bold uk-margin-small-bottom" style="color: #333;"><span><i class="far fa-address-book" style="margin-right: 10px;"></i>MV Directory</span></h2>
            <div>
                <button id="refreshBtn" class="uk-button uk-button-default uk-margin-small-right uk-hidden" style="border-radius: 20px;" uk-tooltip="Refresh data from Airtable">
                    <span uk-icon="refresh"></span> Refresh
                </button>
                <button id="addEntryBtn" class="uk-button uk-button-primary" style="background-color: #32d296; border-radius: 20px;">Add Entry</button>
            </div>
        </div>

        <!-- Search Input -->
        <div class="uk-margin-small-bottom">
            <div class="uk-inline uk-width-1-1">
                <span class="uk-form-icon" uk-icon="icon: search"></span>
                <input type="text" id="searchInput" class="uk-input uk-form-large" placeholder="Search by name, category, or description..." style="border-radius: 8px; padding-left: 40px; font-size: 16px;">
            </div>
        </div>

        <!-- Category Filters -->
        <div class="uk-margin-small-bottom filter-section">
            <div class="filter-container" style="display: block; width: 100%; overflow: hidden;">
                <div class="filter-buttons" style="display: flex; flex-wrap: wrap; width: 100%;">
                    <!-- Buttons will be dynamically added here -->
                </div>
            </div>
        </div>
        
        <style>
            /* Tighten spacing on mobile */
            @media (max-width: 768px) {
                .filter-section {
                    margin-bottom: 0 !important;
                }
                
                #directoryTable_wrapper {
                    margin-top: 0;
                }
                
                /* Remove extra spacing from table elements */
                .dataTables_wrapper .dataTables_length, 
                .dataTables_wrapper .dataTables_filter, 
                .dataTables_wrapper .dataTables_info, 
                .dataTables_wrapper .dataTables_processing, 
                .dataTables_wrapper .dataTables_paginate {
                    margin-top: 0;
                    margin-bottom: 0;
                    padding-top: 0;
                    padding-bottom: 0;
                }
                
                /* Reduce spacing in table cells */
                table.dataTable tbody td {
                    padding-top: 6px;
                    padding-bottom: 6px;
                }
                
                /* Reduce header spacing */
                table.dataTable thead th {
                    padding-top: 12px;
                    padding-bottom: 12px;
                    border-bottom: 1px solid #e5e5e5;
                    color: #666;
                    font-weight: 600;
                    letter-spacing: 0.3px;
                }
            }
        </style>
        
        <style>
            /* Responsive filter buttons */
            .filter-container {
                display: block;
                width: 100%;
                overflow: visible;
            }
            
            .filter-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
                padding: 0 4px;
                width: 100%;
            }
            
            /* Category button styling */
            .category-btn {
                background-color: #1e87f0;
                color: white;
                border-radius: 20px;
                padding: 6px 14px;
                margin: 3px;
                transition: all 0.2s ease;
                border: none;
                font-size: 14px;
            }
            
            .category-btn:hover {
                background-color: #0f7ae5;
                transform: translateY(-1px);
            }
            
            .category-btn.uk-button-primary {
                background-color: #32d296;
            }
            
            /* On mobile, allow buttons to wrap and adjust button size */
            @media (max-width: 768px) {
                .filter-buttons {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 6px;
                    margin-bottom: 0;
                    width: 100%;
                }
                
                /* Reduce spacing around table */
                .uk-margin-small-bottom {
                    margin-bottom: 0 !important;
                }
                
                /* Reduce container padding */
                .uk-card-body {
                    padding: 12px;
                }
                
                /* Reduce table top margin */
                .uk-grid {
                    margin-top: 0 !important;
                }
                
                .category-btn {
                    padding: 8px 6px;
                    font-size: 12px;
                    min-width: auto;
                    margin: 0;
                    flex-grow: 0;
                    width: 100%;
                    text-overflow: ellipsis;
                    overflow: hidden;
                    white-space: nowrap;
                }
                
                /* Special handling for the All button to make it stand out */
                .filter-buttons .category-btn:first-child {
                    grid-column: span 3;
                    width: 50%;
                    margin: 0 auto;
                }
            }
            
            /* For very small screens, reduce to 2 columns */
            @media (max-width: 480px) {
                .filter-buttons {
                    grid-template-columns: repeat(2, 1fr);
                }
                
                .filter-buttons .category-btn:first-child {
                    grid-column: span 2;
                }
                
                /* Mobile modal improvements */
                #add-entry-modal .uk-modal-dialog {
                    position: fixed !important;
                    top: 50% !important;
                    left: 40% !important;
                    transform: translate(-50%, -50%) !important;
                    width: 300px !important;
                    padding: 15px !important;
                    box-sizing: border-box !important;
                    margin: 0 !important;
                }
                
                .uk-modal-title {
                    font-size: 1.25rem;
                    margin-bottom: 10px;
                }
                
                .uk-form-label {
                    margin-bottom: 5px;
                }
                
                .uk-button {
                    padding: 0 15px;
                    font-size: 0.875rem;
                }
                
                /* Stack form buttons vertically on very small screens */
                .uk-margin.uk-text-right {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                /* Make buttons full width */
                .uk-margin.uk-text-right button {
                    width: 100%;
                    margin-left: 0 !important;
                    margin-right: 0 !important;
                }
            }
            
            /* On desktop, keep buttons in a single scrollable row */
            @media (min-width: 769px) {
                .filter-container {
                    overflow-x: auto;
                }
                
                .filter-buttons {
                    white-space: nowrap;
                    flex-wrap: nowrap;
                }
                
                /* Modern table styling */
                #directoryTable {
                    border-collapse: separate;
                    border-spacing: 0;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                }
                
                #directoryTable thead th {
                    background-color: #f8f8f8;
                    font-size: 14px;
                    font-weight: 600;
                    text-transform: capitalize;
                    letter-spacing: 0.2px;
                }
                
                #directoryTable tbody tr {
                    transition: background-color 0.2s ease;
                }
                
                #directoryTable tbody tr:hover {
                    background-color: #f5f9ff;
                }
                
                #directoryTable tbody td {
                    border-top: none;
                    border-bottom: 1px solid #f0f0f0;
                    padding: 14px 10px;
                    vertical-align: middle;
                    font-size: 14px;
                    letter-spacing: 0.1px;
                }
                
                /* Name cell with avatar */
                #directoryTable .name-with-avatar {
                    display: flex;
                    align-items: center;
                    font-weight: 500;
                }
                
                #directoryTable .name-cell {
                    font-weight: 500;
                    color: #1a1a1a;
                    padding: 10px 5px;
                }
                
                #directoryTable .avatar {
                    width: 36px;
                    height: 36px;
                    border-radius: 50%;
                    margin-right: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: 600;
                    font-size: 15px;
                    flex-shrink: 0;
                    letter-spacing: -0.2px;
                }
                
                /* Avatar styling for the name column */
                #directoryTable .avatar {
                    width: 36px;
                    height: 36px;
                    border-radius: 50%;
                    margin-right: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: 600;
                    font-size: 15px;
                    flex-shrink: 0;
                    letter-spacing: -0.2px;
                    object-fit: cover; /* For images */
                }
                
                /* Action buttons */
                #directoryTable .edit-button {
                    background-color: transparent;
                    border: 1px solid #e5e5e5;
                    border-radius: 4px;
                    padding: 6px 10px;
                    color: #666;
                    transition: all 0.2s ease;
                }
                
                #directoryTable .edit-button:hover {
                    background-color: #f5f5f5;
                    color: #333;
                }
            }
        </style>

        <div class="uk-grid uk-grid-small" style="margin-top: 0;">
            <!-- Desktop Table View -->
            <div class="table-view uk-width-1-1">
                <table id="directoryTable" class="uk-table uk-table-striped uk-table-middle display" style="width:100%; margin-top: 0;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Mobile WhatsApp Style View -->
            <div class="whatsapp-view uk-width-1-1">
                <div class="chat-list" id="chatList">
                    <!-- Chat items will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Entry Modal -->
    <div id="add-entry-modal" class="uk-modal-container" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <style>
                /* Modal width styling */
                #add-entry-modal .uk-modal-dialog {
                    width: 400px;
                    max-width: 90%;
                    box-sizing: border-box;
                    margin: 0 auto;
                }
            </style>
            
            <button class="uk-modal-close-default" type="button" uk-close></button>
            <h2 class="uk-modal-title" id="modal-title">Add New Contact</h2>
            <form id="add-entry-form" class="uk-form-stacked">
                <!-- Hidden field for record ID when editing -->
                <input type="hidden" id="form-record-id" value="">
                <!-- Hidden field for logo URL when editing -->
                <input type="hidden" id="form-logo-url" value="">
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-name">Name</label>
                    <div class="uk-form-controls">
                        <input class="uk-input" id="form-name" type="text" placeholder="Business or Contact Name" required>
                    </div>
                </div>
                
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-category">Category</label>
                    <div class="uk-form-controls">
                        <select class="uk-select" id="form-category" required>
                            <!-- Categories will be populated dynamically -->
                        </select>
                    </div>
                </div>
                
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-description">Description</label>
                    <div class="uk-form-controls">
                        <textarea class="uk-textarea" id="form-description" rows="3" placeholder="Brief description of services offered" required></textarea>
                    </div>
                </div>
                
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-phone">Phone Number (WhatsApp)</label>
                    <div class="uk-form-controls">
                        <input class="uk-input" id="form-phone" type="tel" placeholder="e.g. 50688123456" required>
                    </div>
                </div>
                
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-website">Website URL</label>
                    <div class="uk-form-controls">
                        <input class="uk-input" id="form-website" type="url" placeholder="e.g. https://example.com">
                        <small class="uk-text-muted">Optional. Include https:// for proper linking.</small>
                    </div>
                </div>
                
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-logo">Logo/Photo</label>
                    <div class="uk-form-controls">
                        <!-- Image preview container -->
                        <div id="logo-preview-container" class="uk-margin-small-bottom" style="display: none;">
                            <div class="uk-grid uk-grid-small" uk-grid>
                                <div>
                                    <div id="current-logo-preview" style="width: 50px; height: 50px; border-radius: 50%; background-size: cover; background-position: center;">
                                    </div>
                                </div>
                                <div class="uk-width-expand">
                                    <div class="uk-text-small uk-text-muted">Current logo</div>
                                    <button type="button" id="remove-logo-btn" class="uk-button uk-button-small uk-button-default">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- File input -->
                        <div class="js-upload uk-placeholder uk-text-center">
                            <span uk-icon="icon: cloud-upload"></span>
                            <span class="uk-text-middle">Drop a logo image here or</span>
                            <div uk-form-custom>
                                <input type="file" id="form-logo" accept="image/*">
                                <span class="uk-link">select one</span>
                            </div>

                            <p class="uk-text-small uk-text-muted">Recommended: square image, will be displayed as a circle</p>
                        </div>
                        
                        <!-- New logo preview -->
                        <div id="new-logo-preview" style="display: none;">
                            <img id="new-logo-image" style="max-width: 100px; max-height: 100px; border-radius: 50%;">
                            <button type="button" id="cancel-new-logo" class="uk-button uk-button-small uk-button-default uk-margin-small-left">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div class="uk-margin uk-text-right" style="display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 8px;">
                    <!-- Delete button - only show when editing -->
                    <button class="uk-button uk-button-danger" type="button" id="delete-entry" style="display:none; background-color: #f0506e; color: white; font-weight: bold;">Delete</button>
                    <button class="uk-button uk-button-default uk-modal-close" type="button">Cancel</button>
                    <button class="uk-button uk-button-primary" type="submit" id="submit-entry">Submit</button>
                </div>
            </form>
        </div>
    </div>
<script>
        // Check URL parameters and show admin features if needed
        function showAdminFeaturesIfAuthorized() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';
            
            if (isAdmin) {
                // Show refresh button for admins
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.classList.remove('uk-hidden');
                }
            }
        }
        
        // Call this function when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            showAdminFeaturesIfAuthorized();
            
            // Add click handler for refresh button
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    // Show loading notification
                    UIkit.notification({
                        message: 'Refreshing directory data...',
                        status: 'primary',
                        pos: 'top-center',
                        timeout: 3000
                    });
                    
                    // Call the refresh endpoint
                    fetch('/refresh_directory_cache')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Reload the page after a short delay
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1000);
                            } else {
                                UIkit.notification({
                                    message: 'Error refreshing data. Please try again.',
                                    status: 'danger',
                                    pos: 'top-center',
                                    timeout: 3000
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error refreshing cache:', error);
                            UIkit.notification({
                                message: 'Network error. Please try again.',
                                status: 'danger',
                                pos: 'top-center',
                                timeout: 3000
                            });
                        });
                });
            }
        });
        
        // Function to generate a consistent color from a string (name)
        function stringToColor(str) {
            // Simple hash function to get a consistent number from a string
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            // Convert the hash to a hex color
            let color = '#';
            for (let i = 0; i < 3; i++) {
                // Get a value between 0-255
                const value = (hash >> (i * 8)) & 0xFF;
                // Ensure it's not too dark (below 80) or too light (above 200)
                const adjustedValue = Math.min(Math.max(value, 80), 200);
                // Convert to hex and pad with 0 if needed
                color += ('00' + adjustedValue.toString(16)).substr(-2);
            }
            return color;
        }
        
        // Ensure there are no stray modal overlays when the page loads
        document.addEventListener("DOMContentLoaded", function () {
            // Remove any existing modal overlays that might be blocking interactions
            const existingOverlays = document.querySelectorAll('.uk-modal-overlay');
            existingOverlays.forEach(overlay => overlay.remove());
            
            // Make sure no modals are open on page load
            const modals = document.querySelectorAll('.uk-modal');
            modals.forEach(modal => {
                if (modal.classList.contains('uk-open')) {
                    UIkit.modal(modal).hide();
                }
            });
            // Track if we need to refresh cache due to expired URLs
            let needsCacheRefresh = false;
            
            // Function to handle expired image URLs
            function handleExpiredImage(url) {
                console.log('Image URL expired:', url);
                if (!needsCacheRefresh) {
                    needsCacheRefresh = true;
                    
                    // Show a notification about refreshing data
                    UIkit.notification({
                        message: 'Refreshing directory data...',
                        status: 'primary',
                        pos: 'top-center',
                        timeout: 3000
                    });
                    
                    // Make a request to refresh the cache
                    fetch('/refresh_directory_cache')
                        .then(response => response.json())
                        .then(data => {
                            console.log('Cache refresh response:', data);
                            if (data.success) {
                                // After a short delay, refresh the page data
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1000); // Wait for cache to be refreshed
                            }
                        })
                        .catch(error => console.error('Error refreshing cache:', error));
                }
            }
            
            // Setup global error handler for images
            window.addEventListener('error', function(e) {
                const target = e.target;
                // Only handle image errors
                if (target.tagName === 'IMG') {
                    const src = target.src || '';
                    // Check if it's an Airtable URL that might have expired
                    if (src.includes('airtableusercontent.com')) {
                        // Replace with generic avatar and trigger cache refresh
                        const cell = target.closest('.name-with-avatar');
                        if (cell) {
                            // Remove the image
                            target.style.display = 'none';
                            // Handle the expired URL
                            handleExpiredImage(src);
                        }
                    }
                }
            }, true);
            
            // Function to add avatars to name cells
            function addAvatarsToTable() {
                const nameCells = document.querySelectorAll('.name-with-avatar');
                
                nameCells.forEach(cell => {
                    // Check if avatar already exists to prevent duplicates
                    if (cell.querySelector('.avatar')) return;
                    
                    const name = cell.getAttribute('data-name');
                    if (!name) return;
                    
                    const initial = name.charAt(0).toUpperCase();
                    
                    // Generate a color based on the name
                    const colors = ['#32d296', '#1e87f0', '#f0506e', '#faa05a', '#9D33D6', '#00a8e8', '#3e4a61', '#B15DFF', '#2575fc'];
                    const colorIndex = Math.abs(name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)) % colors.length;
                    const bgColor = colors[colorIndex];
                    
                    // Create avatar element
                    const avatar = document.createElement('div');
                    avatar.className = 'avatar';
                    avatar.style.backgroundColor = bgColor;
                    avatar.textContent = initial;
                    
                    // Insert avatar before the name text
                    cell.insertBefore(avatar, cell.firstChild);
                });
            }
            // Get configuration from data attributes
            const serverConfig = document.getElementById('server-config');
            const airtableToken = serverConfig.getAttribute('data-airtable-token');
            const airtableBaseId = serverConfig.getAttribute('data-airtable-base-id');
            const airtableTableName = serverConfig.getAttribute('data-airtable-table-name');
            const airtableUrl = `https://api.airtable.com/v0/${airtableBaseId}/${airtableTableName}`;
            
            // Determine if we should use the cache based on server configuration
            const useCache = serverConfig.getAttribute('data-use-cache') === 'true';
            
            // Choose between cached endpoint and direct Airtable API
            const fetchUrl = useCache ? "/get_directory_data" : airtableUrl;
            const fetchOptions = useCache ? {} : {
                headers: { "Authorization": `Bearer ${airtableToken}`, "Content-Type": "application/json" }
            };
            
            fetch(fetchUrl, fetchOptions)
            .then(response => response.json())
            .then(data => {
                let categories = new Set();
                let categoryMapping = {};

                let records = data.records.map(record => {
                    let category = record.fields["Category"] 
                        ? String(record.fields["Category"]).trim()  
                        : "Uncategorized";  

                    let categoryLower = category.toLowerCase();  
                    categories.add(categoryLower);
                    categoryMapping[categoryLower] = category;

                    let phoneNumber = record.fields["Phone Number"] || "No phone";
                    
                    // âœ… Make phone number clickable for WhatsApp
                    if (phoneNumber !== "No phone") {
                        let cleanNumber = phoneNumber.replace(/\D/g, "");
                        phoneNumber = cleanNumber; // Store clean number for DataTables
                    }
                    
                    // Extract Logo URL from the Airtable data if available
                    let logoUrl = null;
                    
                    // First check for Cloudinary URL as it takes precedence
                    if (record.fields["LogoCloudinaryUrl"]) {
                        logoUrl = record.fields["LogoCloudinaryUrl"];
                        console.log("Using Cloudinary URL:", logoUrl);
                    }
                    // Fallback to Airtable thumbnails if no Cloudinary URL
                    else if (record.fields["Logo"] && Array.isArray(record.fields["Logo"]) && record.fields["Logo"].length > 0) {
                        const logoData = record.fields["Logo"][0];
                        if (logoData.thumbnails) {
                            // Prefer small thumbnail for better performance, fallback to larger sizes
                            if (logoData.thumbnails.small) {
                                logoUrl = logoData.thumbnails.small.url;
                            } else if (logoData.thumbnails.large) {
                                logoUrl = logoData.thumbnails.large.url;
                            } else if (logoData.thumbnails.full) {
                                logoUrl = logoData.thumbnails.full.url;
                            }
                        }
                    }
                    
                    // Debug: Log the first record fields to see the Website URL field
                    if (record === data.records[0]) {
                        console.log('First record fields:', record.fields);
                    }
                    
                    return {
                        Name: record.fields["Title"] || "N/A",
                        Category: category,
                        Description: record.fields["Subtitle"] || "No description",
                        Phone: phoneNumber,
                        Logo: logoUrl, // Add the logo URL to the record data
                        "Website URL": record.fields["Website URL"] || "", // Add the Website URL field
                        RecordId: record.id  // Store the record ID for edit/delete operations
                    };
                });

                // DataTable is already initialized above - no need to reinitialize
                
                // Generate category buttons dynamically
                let filterContainer = document.querySelector(".filter-buttons");
                filterContainer.innerHTML = "";  

                // "Show All" button
                let showAllButton = document.createElement("button");
                showAllButton.className = "uk-button uk-button-primary category-button";
                showAllButton.innerText = "All";
                showAllButton.onclick = function () {
                    // Clear both search inputs
                    const customSearchInput = document.getElementById('searchInput');
                    const dtSearchInput = document.querySelector('.dataTables_filter input');
                    
                    // Clear custom search input
                    if (customSearchInput) {
                        customSearchInput.value = '';
                    }
                    
                    // Clear DataTables search and redraw
                    if (dtSearchInput) {
                        dtSearchInput.value = '';
                        table.search('').draw();
                    }
                    
                    // Clear category filter and URL parameters
                    filterCategory(this, "");
                    updateURLAndFilter("", "");
                    
                    // Remove search parameter from URL if it exists
                    const url = new URL(window.location);
                    url.searchParams.delete('search');
                    window.history.replaceState({}, '', url);
                };
                filterContainer.appendChild(showAllButton);

                // Initialize DataTable with minimal styling
                const tableElement = $('#directoryTable');
                table = tableElement.DataTable({
                    data: records,
                    columns: [
                        { 
                            data: 'Name',
                            render: function(data, type, row) {
                                if (type === 'display') {
                                    // Create the avatar from initials or logo
                                    let avatarHtml = '';
                                    if (row.Logo) {
                                        // Use the logo image if available
                                        avatarHtml = `<img src="${row.Logo}" class="avatar" alt="${data} logo">`;
                                    } else {
                                        // Generate avatar with initials
                                        const initials = data.split(' ')
                                            .map(n => n[0])
                                            .slice(0, 2)
                                            .join('').toUpperCase();
                                        
                                        const bgColor = stringToColor(data);
                                        avatarHtml = `<div class="avatar" style="background-color: ${bgColor}">${initials}</div>`;
                                    }
                                    // Return the name with avatar in the same cell
                                    return `<div class="name-with-avatar" data-name="${data}">${avatarHtml}${data}</div>`;
                                }
                                return data;
                            },
                            width: '20%'
                        },
                        { 
                            data: 'Category',
                            width: '15%'
                        },
                        { 
                            data: 'Description',
                            width: '40%'
                        },
                        {
                            data: 'Phone',
                            render: function(data, type, row) {
                                if (type === 'display' && data) {
                                    return `<a href="https://wa.me/${data}" class="chat-phone" target="_blank">
                                            <i class="fab fa-whatsapp"></i>${data}
                                           </a>`;
                                }
                                return data;
                            },
                            width: '15%'
                        },
                        {
                            data: null,
                            render: function(data, type, row) {
                                let html = `<button class="uk-button uk-button-small edit-button" data-record-id="${row.RecordId}"><span uk-icon="pencil"></span></button>`;
                                
                                // Add website icon if URL exists
                                if (row['Website URL']) {
                                    html += `<a href="${row['Website URL']}" class="uk-button uk-button-small uk-button-link" target="_blank" title="Visit Website"><span uk-icon="world"></span></a>`;
                                }
                                
                                return html;
                            },
                            orderable: false,
                            width: '40px',
                            className: 'dt-body-center never-hide',
                            responsivePriority: 1
                        }
                    ],
                    order: [[0, 'asc']],
                    pageLength: -1, // Show all records
                    paging: false, // Disable pagination
                    dom: 't', // Only show the table, no controls
                    language: {
                        search: '',
                        searchPlaceholder: 'Search...',
                        emptyTable: "No entries found. Add a new entry to get started!",
                        zeroRecords: "No matching entries found."
                    },
                    // Modern styling
                    autoWidth: false,
                    ordering: true,
                    columnDefs: [
                        { targets: [2, 3, 4], orderable: false },  // Make Description, Phone and Actions columns non-sortable
                        { className: "dt-center", targets: [1, 3, 4] }  // Center align Category, Phone, and Actions columns
                    ],
                    searching: true,
                    rowCallback: function(row, data, index) {
                        // Add subtle alternating row color
                        if (index % 2 === 0) {
                            $(row).css('background-color', '#fafafa');
                        }
                    }
                });
                
                // After table is initialized, add avatars
                setTimeout(addAvatarsToTable, 100);
                
                // Handle edit button clicks - simplified approach
                $('#directoryTable').on('click', '.edit-button', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Get the record ID from the button
                    const recordId = $(this).data('record-id');
                    
                    if (recordId) {
                        // Find the record in the data
                        const record = records.find(r => r.RecordId === recordId);
                        if (record) {
                            openEditModal(record);
                        }
                    }
                });
                
                // Function to apply custom styling
                function applyCustomStyling() {
                    // Remove all existing styles
                    $('#directoryTable tbody tr').removeClass('odd even');
                    $('#directoryTable tbody tr td').removeAttr('style').removeAttr('class');
                    
                    // Apply our custom styling
                    $('#directoryTable tbody tr').each(function(index) {
                        // Set background color based on row index
                        const bgColor = index % 2 === 0 ? '#f5f5f5' : '#ffffff';
                        
                        // Apply to the entire row first
                        $(this).css('background-color', bgColor);
                        
                        // Then force each cell to have the same background
                        $(this).find('td').each(function() {
                            $(this).attr('style', 'background-color: ' + bgColor + ' !important');
                        });
                        
                        // Special handling for first column
                        $(this).find('td:first-child').attr('style', 'background-color: ' + bgColor + ' !important; font-weight: 500; color: #1a1a1a;');
                    });
                }
                
                // Apply styling initially and after any DataTable events
                applyCustomStyling();
                table.on('draw', applyCustomStyling);
                table.on('page', applyCustomStyling);
                table.on('order', applyCustomStyling);

                // Category filtering function
                function filterByCategory(category) {
                    const buttons = document.querySelectorAll('.filter-buttons .category-btn');
                    buttons.forEach(btn => {
                        if (btn.textContent === category) {
                            btn.classList.add('uk-button-primary');
                        } else {
                            btn.classList.remove('uk-button-primary');
                        }
                    });

                    table.column(1).search(category === 'All' ? '' : category).draw();

                    const url = new URL(window.location);
                    if (category === 'All') {
                        url.searchParams.delete('category');
                    } else {
                        url.searchParams.set('category', category);
                    }
                    window.history.pushState({}, '', url);
                }

                // Create and initialize category buttons
                const uniqueCategories = [...new Set(records.map(record => record.Category))];
                uniqueCategories.sort();

                const filterButtons = document.querySelector('.filter-buttons');
                filterButtons.innerHTML = '';
                
                // Add All button first
                const allButton = document.createElement('button');
                allButton.className = 'uk-button uk-button-primary category-btn';
                allButton.textContent = 'All';
                allButton.addEventListener('click', () => filterByCategory('All'));
                filterButtons.appendChild(allButton);

                // Add other category buttons
                uniqueCategories.forEach(category => {
                    const button = document.createElement('button');
                    button.className = 'uk-button category-btn';
                    button.textContent = category;
                    button.addEventListener('click', () => filterByCategory(category));
                    filterButtons.appendChild(button);
                });

                // Check URL for initial category filter
                const urlParams = new URLSearchParams(window.location.search);
                const initialCategory = urlParams.get('category') || 'All';
                if (initialCategory !== 'All') {
                    filterByCategory(initialCategory);
                }

                // Initialize search functionality
                $('#searchInput').on('keyup', function() {
                    table.search(this.value).draw();
                });

                // âœ… Populate WhatsApp style view
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = ''; // Clear existing items

                // Populate mobile chat view
                function populateChatList(records) {
                    const chatList = document.getElementById('chatList');
                    chatList.innerHTML = ''; // Clear existing items

                    records.forEach(record => {
                        const phoneNumber = record.Phone ? record.Phone.replace(/[^0-9]/g, '') : '';
                        const initial = record.Name ? record.Name.charAt(0).toUpperCase() : '?';
                        
                        // Create div instead of <a> to allow edit button to work
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-item';
                        
                        // Create wrapper for content and edit button
                        const contentWrapper = document.createElement('div');
                        contentWrapper.className = 'chat-item-wrapper';
                        contentWrapper.style.display = 'flex';
                        contentWrapper.style.width = '100%';
                        contentWrapper.style.justifyContent = 'space-between';
                        contentWrapper.style.alignItems = 'flex-start';
                        contentWrapper.style.position = 'relative';
                        
                        // Add avatar and content to a left container
                        const leftContainer = document.createElement('div');
                        leftContainer.style.display = 'flex';
                        leftContainer.style.flex = '1';
                        leftContainer.style.width = 'calc(100% - 10px)';
                        leftContainer.style.overflow = 'visible';
                        leftContainer.style.boxSizing = 'border-box';
                        
                        // Create the avatar with dynamic color based on name
                        const avatar = document.createElement('div');
                        avatar.className = 'chat-avatar';
                        avatar.textContent = initial;
                        
                        // Generate a color based on the name (matching desktop view)
                        const colors = ['#32d296', '#1e87f0', '#f0506e', '#faa05a', '#9D33D6', '#00a8e8', '#3e4a61', '#B15DFF', '#2575fc'];
                        const colorIndex = Math.abs(record.Name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)) % colors.length;
                        const bgColor = colors[colorIndex];
                        avatar.style.backgroundColor = bgColor;
                        
                        leftContainer.appendChild(avatar);
                        
                        // Create the content
                        const content = document.createElement('div');
                        content.className = 'chat-content';
                        content.style.width = '100%';
                        content.innerHTML = `
                            <div class="chat-title" style="padding-right: 40px;">${record.Name || 'Unknown'}</div>
                            <div class="chat-category">${record.Category || 'Uncategorized'}</div>
                            <div class="chat-preview" style="width: 100%;">${record.Description || 'No description available'}</div>
                        `;
                        
                        // Create phone link if available
                        if (record.Phone) {
                            const phoneLink = document.createElement('a');
                            phoneLink.href = `https://wa.me/${phoneNumber}`;
                            phoneLink.className = 'chat-phone';
                            phoneLink.innerHTML = `<i class="fab fa-whatsapp"></i>${record.Phone}`;
                            content.appendChild(phoneLink);
                        }
                        
                        // Create website link if available
                        if (record['Website URL']) {
                            const websiteLink = document.createElement('a');
                            websiteLink.href = record['Website URL'];
                            websiteLink.className = 'chat-website';
                            websiteLink.target = '_blank';
                            websiteLink.style.display = 'block';
                            websiteLink.style.marginTop = '4px';
                            websiteLink.innerHTML = `<i class="fas fa-globe"></i>Website`;
                            content.appendChild(websiteLink);
                        }
                        
                        leftContainer.appendChild(content);
                        contentWrapper.appendChild(leftContainer);
                        
                        // Create edit button
                        const editButton = document.createElement('button');
                        editButton.className = 'uk-button uk-button-small uk-button-primary edit-btn';
                        editButton.style.flexShrink = '0';
                        editButton.style.position = 'absolute';
                        editButton.style.right = '0';
                        editButton.style.top = '0';
                        editButton.style.zIndex = '1';
                        editButton.style.padding = '4px 10px';
                        editButton.innerHTML = '<span uk-icon="pencil"></span>';
                        editButton.setAttribute('data-record-id', record.RecordId);
                        
                        // Add click event to edit button
                        editButton.addEventListener('click', function(e) {
                            e.preventDefault(); // Prevent any parent link from being followed
                            e.stopPropagation(); // Stop event from bubbling up
                            openEditModal(record);
                        });
                        
                        contentWrapper.appendChild(editButton);
                        chatItem.appendChild(contentWrapper);
                        
                        // Add the completed chat item to the chat list
                        chatList.appendChild(chatItem);
                    });
                }

                // Initial population of chat list
                populateChatList(records);

                // Update mobile view when table is filtered
                table.on('search.dt', function() {
                    const filteredData = table.rows({ search: 'applied' }).data().toArray();
                    populateChatList(filteredData);
                });

                // Handle mobile/desktop view switching
                function toggleViews() {
                    const isMobile = window.innerWidth <= 768;
                    document.querySelector('.table-view').style.display = isMobile ? 'none' : 'block';
                    document.querySelector('.whatsapp-view').style.display = isMobile ? 'block' : 'none';
                }

                // Initial check and listen for resize
                toggleViews();
                window.addEventListener('resize', toggleViews);

                // âœ… Function to update URL and apply filtering
                function updateURLAndFilter(category, searchTerm) {
                    let params = new URLSearchParams(window.location.search);

                    // Update category filter
                    if (category !== null) {
                        if (category === "") {
                            params.delete("category");
                            table.column(1).search("", false, false).draw();
                        } else {
                            params.set("category", category);
                            table.column(1).search("^" + $.fn.dataTable.util.escapeRegex(category) + "$", true, false).draw();
                        }
                    }

                    // Update search term
                    if (searchTerm !== null) {
                        if (searchTerm === "") {
                            params.delete("search");
                        } else {
                            params.set("search", searchTerm);
                        }
                        table.search(searchTerm).draw();
                    }

                    // Update URL without adding empty parameters
                    const urlParams = params.toString();
                    history.pushState({}, "", urlParams ? "?" + urlParams : window.location.pathname);
                }

                // âœ… Handle Search Input Updates URL
                document.getElementById("searchInput").addEventListener("keyup", function () {
                    updateURLAndFilter(null, this.value);
                });

                // âœ… On Page Load, Apply URL Filters
                function applyURLFilters() {
                    let params = new URLSearchParams(window.location.search);
                    let category = params.get("category");
                    let searchTerm = params.get("search");

                    if (category) {
                        if (category === "") {
                            table.column(1).search("").draw(); // âœ… Ensure "Show All" works
                        } else {
                            table.column(1).search(`^${category}$`, true, false).draw();
                        }
                        // Find and highlight the button for this category
                        let categoryButton = [...document.querySelectorAll(".category-button")]
                            .find(button => button.innerText.toLowerCase() === category.toLowerCase());
                        if (categoryButton) {
                            filterCategory(categoryButton, categoryButton.innerText, false);
                        }
                    }

                    if (searchTerm) {
                        document.getElementById("searchInput").value = searchTerm;
                        table.search(searchTerm).draw();
                    }
                }

                // âœ… Handle category filtering and button styling
                function filterCategory(button, category, updateState = true) {
                    // Reset all buttons to primary (blue) style
                    document.querySelectorAll(".category-button").forEach(btn => {
                        btn.classList.remove("category-selected");
                    });

                    // Add selected class to highlight the clicked button
                    button.classList.add("category-selected");

                    // Update URL and filter table if needed
                    if (updateState) {
                        updateURLAndFilter(category, null);
                    }
                }

                applyURLFilters(); 
                
                // Populate the category dropdown in the Add Entry form
                const categorySelect = document.getElementById('form-category');
                categorySelect.innerHTML = '';
                
                // Add a default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a category';
                categorySelect.appendChild(defaultOption);
                
                // Use actual categories from Airtable
                // This ensures we use exactly the same category values that exist in Airtable
                const existingCategories = [...categories].map(cat => categoryMapping[cat]);
                existingCategories.sort();
                
                existingCategories.forEach(category => {
                    if (category) { // Skip empty categories
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    }
                });
                
                // Function to open the modal for editing
                function openEditModal(data) {
                    // Set modal title
                    document.getElementById('modal-title').textContent = 'Edit Contact';
                    
                    // Store record ID
                    document.getElementById('form-record-id').value = data.RecordId;
                    
                    // Store logo URL in hidden field and show preview if available
                    const logoUrl = data.Logo || '';
                    document.getElementById('form-logo-url').value = logoUrl;
                    
                    // Display current logo if available
                    const logoPreviewContainer = document.getElementById('logo-preview-container');
                    const currentLogoPreview = document.getElementById('current-logo-preview');
                    
                    if (logoUrl) {
                        // Show logo preview
                        currentLogoPreview.style.backgroundImage = `url(${logoUrl})`;
                        logoPreviewContainer.style.display = 'block';
                    } else {
                        // Hide logo preview if no logo
                        logoPreviewContainer.style.display = 'none';
                        currentLogoPreview.style.backgroundImage = '';
                    }
                    
                    // Hide new logo preview
                    document.getElementById('new-logo-preview').style.display = 'none';
                    
                    // Populate form fields
                    document.getElementById('form-name').value = data.Name === 'N/A' ? '' : data.Name;
                    
                    // For the category dropdown, find and select the right option
                    const categorySelect = document.getElementById('form-category');
                    for (let i = 0; i < categorySelect.options.length; i++) {
                        if (categorySelect.options[i].value === data.Category) {
                            categorySelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    document.getElementById('form-description').value = 
                        data.Description === 'No description' ? '' : data.Description;
                    document.getElementById('form-phone').value = 
                        data.Phone === 'No phone' ? '' : data.Phone;
                    
                    // Populate Website URL field if available
                    document.getElementById('form-website').value = 
                        data['Website URL'] || '';
                        
                    // Change submit button text
                    document.getElementById('submit-entry').textContent = 'Save Changes';
                    
                    // Show the delete button when editing
                    document.getElementById('delete-entry').style.display = 'inline-block';
                    
                    // Show the modal
                    UIkit.modal('#add-entry-modal').show();
                }
                
                // Function to reset the modal for adding a new entry
                function resetModalForAdd() {
                    // Set modal title
                    document.getElementById('modal-title').textContent = 'Add New Contact';
                    
                    // Clear record ID and logo url
                    document.getElementById('form-record-id').value = '';
                    document.getElementById('form-logo-url').value = '';
                    
                    // Reset logo previews
                    document.getElementById('logo-preview-container').style.display = 'none';
                    document.getElementById('new-logo-preview').style.display = 'none';
                    document.getElementById('current-logo-preview').style.backgroundImage = '';
                    
                    // Reset file input
                    const fileInput = document.getElementById('form-logo');
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    
                    // Clear form fields
                    document.getElementById('form-name').value = '';
                    document.getElementById('form-category').selectedIndex = 0;
                    document.getElementById('form-description').value = '';
                    document.getElementById('form-phone').value = '';
                    document.getElementById('form-website').value = '';
                    
                    // Reset submit button text
                    document.getElementById('submit-entry').textContent = 'Submit';
                    
                    // Hide the delete button when adding
                    document.getElementById('delete-entry').style.display = 'none';
                }
                
                // Set up the Add Entry button to open the modal for adding
                document.getElementById('addEntryBtn').addEventListener('click', function() {
                    resetModalForAdd();
                    UIkit.modal('#add-entry-modal').show();
                });
                
                // Make sure the modal is reset when it's closed
                UIkit.util.on('#add-entry-modal', 'hidden', function() {
                    resetModalForAdd();
                });
                
                // Handle logo file input changes
                document.getElementById('form-logo').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Show the new logo preview
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const img = document.getElementById('new-logo-image');
                            img.src = event.target.result;
                            document.getElementById('new-logo-preview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // Handle remove logo button
                document.getElementById('remove-logo-btn').addEventListener('click', function() {
                    console.log('Remove logo button clicked');
                    
                    // Clear the logo URL
                    const logoUrlField = document.getElementById('form-logo-url');
                    console.log('Previous logo URL:', logoUrlField.value);
                    logoUrlField.value = '';
                    console.log('Cleared logo URL:', logoUrlField.value);
                    
                    // Hide the preview container
                    const previewContainer = document.getElementById('logo-preview-container');
                    previewContainer.style.display = 'none';
                    console.log('Set preview container display to:', previewContainer.style.display);
                    
                    // Clear the background image
                    document.getElementById('current-logo-preview').style.backgroundImage = '';
                    
                    // Create a flag to indicate removal
                    if (!document.getElementById('logo-removed-flag')) {
                        const removalFlag = document.createElement('input');
                        removalFlag.type = 'hidden';
                        removalFlag.id = 'logo-removed-flag';
                        removalFlag.name = 'logo-removed-flag';
                        removalFlag.value = 'true';
                        document.getElementById('add-entry-form').appendChild(removalFlag);
                        console.log('Added logo removal flag to form');
                    }
                });
                
                // Handle cancel new logo button
                document.getElementById('cancel-new-logo').addEventListener('click', function() {
                    // Clear the file input and hide the preview
                    document.getElementById('form-logo').value = '';
                    document.getElementById('new-logo-preview').style.display = 'none';
                });
                
                // Handle delete button click
                document.getElementById('delete-entry').addEventListener('click', function() {
                    const recordId = document.getElementById('form-record-id').value;
                    const entryName = document.getElementById('form-name').value;
                    
                    if (!recordId) {
                        UIkit.notification({
                            message: 'No record ID found. Cannot delete.',
                            status: 'danger',
                            pos: 'top-center',
                            timeout: 3000
                        });
                        return;
                    }
                    
                    // Show confirmation dialog
                    UIkit.modal.confirm(`Are you sure you want to delete "${entryName}"? This action cannot be undone.`)
                    .then(function() {
                        // User confirmed delete
                        deleteEntry(recordId);
                    }, function() {
                        // User canceled delete
                        console.log('Delete canceled');
                    });
                });
                
                // Function to delete an entry
                function deleteEntry(recordId) {
                    // Show loading state
                    const deleteBtn = document.getElementById('delete-entry');
                    const originalText = deleteBtn.textContent;
                    deleteBtn.disabled = true;
                    deleteBtn.textContent = 'Deleting...';
                    
                    // Call the server to delete the entry
                    fetch('/delete_directory_entry', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            record_id: recordId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Reset button state
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = originalText;
                        
                        if (data.success) {
                            // Close modal
                            UIkit.modal('#add-entry-modal').hide();
                            
                            // Remove row from table
                            const rows = table.rows().indexes();
                            for (let i = 0; i < rows.length; i++) {
                                const rowData = table.row(rows[i]).data();
                                if (rowData.RecordId === recordId) {
                                    table.row(rows[i]).remove().draw();
                                    break;
                                }
                            }
                            
                            // Show success message
                            UIkit.notification({
                                message: 'Contact deleted successfully',
                                status: 'success',
                                pos: 'top-center',
                                timeout: 3000
                            });
                            
                            // Re-add avatars to ensure they're displayed properly
                            setTimeout(function() {
                                addAvatarsToTable();
                            }, 100);
                        } else {
                            // Show error message
                            UIkit.notification({
                                message: data.error || 'Failed to delete contact',
                                status: 'danger',
                                pos: 'top-center',
                                timeout: 5000
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting entry:', error);
                        
                        // Reset button state
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = originalText;
                        
                        // Show error notification
                        let errorMessage = error.message;
                        
                        // Handle specific error messages
                        if (errorMessage.includes('JSON') || errorMessage.includes('Unexpected token')) {
                            errorMessage = 'Server error. Please check if all Airtable credentials are set in the .env file.';
                        }
                        
                        UIkit.notification({
                            message: `Error deleting entry: ${errorMessage}`,
                            status: 'danger',
                            pos: 'top-center',
                            timeout: 5000
                        });
                    });
                }
                
                // Handle form submission
                document.getElementById('add-entry-form').addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const submitBtn = document.getElementById('submit-entry');
                    const category = document.getElementById('form-category').value;
                    const title = document.getElementById('form-name').value;
                    const recordId = document.getElementById('form-record-id').value;
                    const isEdit = !!recordId;
                    
                    // Validate required fields
                    if (!title.trim()) {
                        UIkit.notification({
                            message: 'Title is required',
                            status: 'danger',
                            pos: 'top-center',
                            timeout: 3000
                        });
                        return;
                    }
                    
                    if (!category) {
                        UIkit.notification({
                            message: 'Please select a category',
                            status: 'danger',
                            pos: 'top-center',
                            timeout: 3000
                        });
                        return;
                    }
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEdit ? 'Saving...' : 'Submitting...';
                    
                    // Create form data with proper fields
                    const fileInput = document.getElementById('form-logo');
                    const hasNewFile = fileInput.files && fileInput.files.length > 0;
                    const existingLogoUrl = document.getElementById('form-logo-url').value;
                    // Check for our explicit removal flag rather than relying on display state
                    const logoRemovedFlag = document.getElementById('logo-removed-flag');
                    const shouldRemoveLogo = logoRemovedFlag ? true : false;
                    
                    console.log('Logo removal debug:', {
                        existingLogoUrl,
                        logoRemovedFlag: logoRemovedFlag ? 'true' : 'false',
                        shouldRemoveLogo,
                        logoPreviewContainerDisplay: document.getElementById('logo-preview-container').style.display
                    });
                    
                    // Prepare a FormData object for multipart submission
                    const multipartFormData = new FormData();
                    
                    // Basic Airtable fields data as JSON
                    const fieldsData = {
                        fields: {
                            "Title": title.trim(),
                            "Category": [category], // Put category in an array for Multiple Select field
                            "Subtitle": document.getElementById('form-description').value.trim(),
                            "Phone Number": document.getElementById('form-phone').value.trim(),
                            "Website URL": document.getElementById('form-website').value.trim() || null
                        }
                    };
                    
                    // If editing, add the record ID
                    if (isEdit) {
                        fieldsData.record_id = recordId;
                    }
                    
                    // Append fields data as JSON
                    multipartFormData.append('data', JSON.stringify(fieldsData));
                    
                    // Append logo action
                    if (hasNewFile) {
                        multipartFormData.append('logo_action', 'upload');
                        multipartFormData.append('logo_file', fileInput.files[0]);
                    } else if (shouldRemoveLogo) {
                        multipartFormData.append('logo_action', 'remove');
                    } else {
                        multipartFormData.append('logo_action', 'keep');
                    }
                    
                    console.log(`Sending ${isEdit ? 'update' : 'add'} data:`, fieldsData);
                    
                    // Determine which endpoint to use
                    const endpoint = isEdit ? '/update_directory_entry' : '/add_directory_entry';
                    
                    // Submit to our backend route which will forward to Airtable
                    // When sending FormData, do not set Content-Type - browser will set it with boundary
                    fetch(endpoint, {
                        method: 'POST',
                        body: multipartFormData
                    })
                    .then(async response => {
                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.error || 'Network response was not ok');
                        }
                        return data;
                    })
                    .then(data => {
                        // Get the phone number in the correct format for display
                        const phoneNumber = fieldsData.fields["Phone Number"] ? 
                            fieldsData.fields["Phone Number"] : 'No phone';
                            
                        // Create record object for the table
                        const updatedRecord = {
                            Name: fieldsData.fields["Title"],
                            Category: fieldsData.fields["Category"][0], // First item from category array
                            Description: fieldsData.fields["Subtitle"] || "No description",
                            Phone: phoneNumber,
                            // For logo, we need to respect when it's intentionally removed
                            // If the user removed the logo (logo_action was 'remove'), data.logoUrl will be null
                            // In that case, we should use null, not fall back to existingLogoUrl
                            Logo: shouldRemoveLogo ? null : (data.logoUrl || existingLogoUrl),
                            RecordId: isEdit ? recordId : (data.id || '') // Use existing ID or get from response
                        };
                        
                        if (isEdit) {
                            // Find the row with matching record ID and update it
                            const rowIndex = table.rows().indexes().filter(idx => {
                                const rowData = table.row(idx).data();
                                return rowData.RecordId === recordId;
                            });
                            
                            if (rowIndex.length > 0) {
                                table.row(rowIndex[0]).data(updatedRecord).draw(false);
                            }
                            
                            // Show success notification for update
                            UIkit.notification({
                                message: `Successfully updated ${fieldsData.fields["Title"]}!`,
                                status: 'success',
                                pos: 'top-center',
                                timeout: 3000
                            });
                        } else {
                            // Add new row for a new entry
                            table.row.add(updatedRecord).draw(false);
                            
                            // Show success notification for new entry
                            UIkit.notification({
                                message: `Successfully added ${fieldsData.fields["Title"]} to the directory!`,
                                status: 'success',
                                pos: 'top-center',
                                timeout: 3000
                            });
                        }
                        
                        // Close modal and reset the form
                        UIkit.modal('#add-entry-modal').hide();
                        
                        // Apply any custom styling needed
                        if (typeof applyCustomStyling === 'function') {
                            applyCustomStyling();
                        }
                        
                        // Re-add avatars to the table cells after update/add
                        setTimeout(function() {
                            addAvatarsToTable();
                        }, 100); // Small delay to ensure the table has finished rendering
                        
                        // Reset submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit';
                    })
                    .catch(error => {
                        console.error(`Error ${isEdit ? 'updating' : 'adding'} entry:`, error);
                        
                        // Attempt to parse error message from JSON response if possible
                        let errorMessage = error.message;
                        
                        // For more specific error messages when available
                        if (errorMessage.includes('JSON') || errorMessage.includes('Unexpected token')) {
                            errorMessage = 'Server error. Please check if all Airtable credentials are set in the .env file.';
                        }
                        
                        // Show error notification with more specific message
                        UIkit.notification({
                            message: errorMessage || `Failed to ${isEdit ? 'update' : 'add'} entry. Please check your input and try again.`,
                            status: 'danger',
                            pos: 'top-center',
                            timeout: 5000
                        });
                    })
                    .finally(() => {
                        // Reset submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = isEdit ? 'Save Changes' : 'Submit';
                    });
                });
            })
            .catch(error => console.error("Error fetching Airtable data:", error));
        });
</script>



</body>
</html>

