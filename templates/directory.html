<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Directory</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">

    <!-- UIKit 3 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.16.26/dist/css/uikit.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.16.26/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.16.26/dist/js/uikit-icons.min.js"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    
    <!-- Custom CSS to override DataTables styling -->
    <style>
        /* Override DataTables row background colors */
        table.dataTable tbody tr,
        table.dataTable tbody tr.odd,
        table.dataTable tbody tr.even {
            background-color: transparent !important;
        }
        
        /* Completely disable DataTables styling */
        table.dataTable.stripe tbody tr.odd,
        table.dataTable.display tbody tr.odd {
            background-color: transparent !important;
        }
        
        table.dataTable.stripe tbody tr.even,
        table.dataTable.display tbody tr.even {
            background-color: transparent !important;
        }
        
        /* Override any cell-specific styling */
        table.dataTable tbody td {
            background-color: inherit !important;
        }
        
        /* Set explicit background colors for all cells */
        table.dataTable tbody tr:nth-child(odd) td {
            background-color: #ffffff !important;
        }
        
        table.dataTable tbody tr:nth-child(even) td {
            background-color: #f5f5f5 !important;
        }
    </style>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <!-- jQuery & DataTables.js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <style>
        /* General Styling */
        body {
            font-family: "Arial", sans-serif;
            background-color: #f8f9fa;
            margin: 20px;
        }
        
        /* Force consistent row backgrounds - completely override DataTables styling */
        table.dataTable.stripe tbody tr.odd,
        table.dataTable.stripe tbody tr.odd td,
        table.dataTable tbody tr:nth-child(odd),
        table.dataTable tbody tr:nth-child(odd) td {
            background-color: #ffffff !important;
        }
        
        table.dataTable.stripe tbody tr.even,
        table.dataTable.stripe tbody tr.even td,
        table.dataTable tbody tr:nth-child(even),
        table.dataTable tbody tr:nth-child(even) td {
            background-color: #f5f5f5 !important;
        }
        
        .container {
            max-width: 100%;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    
        /* Ensure table cells have enough padding for readability */
        table.dataTable tbody tr {
            height: auto;
        }
        
        table.dataTable td {
            font-size: 16px;
            padding: 12px;
            word-break: break-word; /* Prevent text overflow */
        }
    
        /* Prevent Table Overflow on Small Screens */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        }
    
        /* ðŸ“Œ Improve category button layout */
        .filter-buttons {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            justify-content: flex-start;
            margin-bottom: 2px;
            overflow-x: auto;
            padding-bottom: 0;
            -webkit-overflow-scrolling: touch;
        }

        /* ðŸ“Œ Category buttons - more compact & uniform */
        .filter-buttons button {
            flex-grow: 0;
            flex-shrink: 0;
            min-width: 80px;
            padding: 5px 10px;
            font-size: 14px;
            text-align: center;
            border-radius: 16px;
            white-space: nowrap;
        }

        /* ðŸ“Œ Ensure table is scrollable & responsive */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            padding: 10px;
        }

        /* ðŸ“Œ Ensure table has proper column spacing */
        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
            margin-top: 4px !important;
        }

        /* Apply alternating colors to entire rows */
        table.dataTable tbody tr:nth-child(odd) {
            background-color: #ffffff !important;
        }
        
        table.dataTable tbody tr:nth-child(even) {
            background-color: #f5f5f5 !important;
        }

        /* ðŸ“Œ Adjust column widths */
        table.dataTable th:nth-child(1), /* Name Column */
        table.dataTable td:nth-child(1) {
            width: 25%;
            font-weight: bold;
        }

        table.dataTable th:nth-child(2), /* Category */
        table.dataTable td:nth-child(2) {
            width: 15%;
            text-align: center;
        }

        table.dataTable th:nth-child(3), /* Description */
        table.dataTable td:nth-child(3) {
            width: 40%;
        }

        table.dataTable th:nth-child(4), /* Phone Number */
        table.dataTable td:nth-child(4) {
            width: 20%;
            text-align: right;
            padding-right: 24px;
        }

        /* Phone number styling */
        .chat-phone {
            display: inline-flex;
            align-items: center;
            background: #e8f5e9;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 400;
            text-decoration: none;
            color: #1a1a1a;
            transition: all 0.2s ease;
        }

        .chat-phone:hover {
            background: #c8e6c9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(37,211,102,0.1);
            text-decoration: none;
            color: #1a1a1a;
        }

        .chat-phone i {
            color: #25D366;
            margin-right: 8px;
            font-size: 18px;
        }

        /* ðŸ“Œ Improve row styling */
        table.dataTable tbody td {
            background-color: transparent !important;
        }

        table.dataTable tbody tr:hover {
            background-color: #f1f1f1 !important; /* Highlight on hover */
        }

        /* ðŸ“Œ Highlight search results */
        table.dataTable td.highlight {
            background-color: yellow !important;
            font-weight: bold;
        }

        /* ðŸ“Œ Selected category button style */
        .uk-button {
            border-radius: 16px;
            padding: 0 10px;
            font-size: 13px;
            text-transform: capitalize;
            transition: all 0.2s ease;
            background: #1e87f0;
            border: 1px solid #1e87f0;
            color: white;
            margin: 0 1px;
            height: 26px;
            line-height: 24px;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .uk-button:hover {
            background: #0f7ae5;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(30,135,240,0.2);
        }

        .uk-button.uk-button-primary {
            background-color: #32d296 !important;
            color: white !important;
            border-color: #32d296 !important;
            box-shadow: 0 2px 4px rgba(50,210,150,0.2);
            font-weight: 500;
        }
        /* Desktop/Mobile View Toggle */
        .table-view { 
            display: block; 
        }

        /* Table styling improvements */
        table.dataTable {
            border-collapse: collapse;
            border-spacing: 0;
            margin: 0 !important;
            width: 100%;
        }

        table.dataTable thead th {
            border-bottom: 1px solid #e5e5e5;
            padding: 4px 20px;
            font-weight: 500;
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: transparent;
        }

        table.dataTable tbody td {
            padding: 8px 20px;
            vertical-align: middle;
            border: none;
            border-bottom: 1px solid #e5e5e5;
            transition: all 0.2s ease;
            line-height: 1.3;
            font-size: 14px;
            color: #333;
            background: none !important;
        }

        table.dataTable tbody td:first-child {
            border-left: 1px solid #e5e5e5;
        }

        table.dataTable tbody td:last-child {
            border-right: 1px solid #e5e5e5;
        }

        table.dataTable tbody tr:hover td {
            background-color: #e9f0f7 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
        }

        table.dataTable tbody tr td:first-child {
            font-weight: 500;
            color: #1a1a1a;
        }
        .whatsapp-view { display: none !important; }

        /* WhatsApp button styling for both mobile and desktop */
        .chat-phone {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            background: #e8f5e9;
            text-decoration: none;
            color: #000;
            width: fit-content;
            font-size: 14px;
            line-height: 1.2;
        }

        .chat-phone i {
            color: #25D366;
            margin-right: 6px;
            font-size: 16px;
        }

        .chat-phone span {
            color: #000;
            font-weight: 400;
        }

        /* RESPONSIVE LAYOUT */
        @media (max-width: 768px) {
            .table-view { display: none !important; }
            .whatsapp-view { 
                display: block !important;
                margin-top: 20px;
            }

            .filter-buttons {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin: 16px 0;
            }

            .filter-buttons button {
                width: 100%;
                min-width: 0;
                padding: 8px;
                font-size: 13px;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Chat List Styling */
            .chat-list {
                background: white;
                border-radius: 8px;
                margin-top: 16px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .chat-item {
                display: flex;
                align-items: flex-start;
                padding: 16px;
                border-bottom: 1px solid #e5e5e5;
                text-decoration: none;
                color: inherit;
                background: white;
                transition: background-color 0.2s;
            }

            .chat-item:last-child {
                border-bottom: none;
                border-radius: 0 0 8px 8px;
            }

            .chat-item:first-child {
                border-radius: 8px 8px 0 0;
            }

            .chat-item:active {
                background-color: #f5f5f5;
            }

            .chat-avatar {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                background: #32d296;
                margin-right: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                flex-shrink: 0;
            }

            .chat-content {
                flex-grow: 1;
                min-width: 0;
            }

            .chat-title {
                font-weight: bold;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .chat-category {
                display: inline-block;
                font-size: 12px;
                padding: 2px 8px;
                border-radius: 12px;
                background: #e8f5e9;
                color: #1b5e20;
                margin-bottom: 4px;
            }

            .chat-preview {
                color: #666;
                font-size: 14px;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }



            /* Mobile-specific margin */
            @media (max-width: 768px) {
                .chat-phone {
                    margin-top: 8px;
                }
            }

            .chat-phone:active {
                background: #c8e6c9;
            }

            .chat-phone i {
                margin-right: 6px;
                color: #25D366;
            }

            /* If category count is odd, center last button */
            .filter-buttons button:nth-child(odd):last-child {
                width: 100%;
            }

            /* ðŸ“Œ Ensure table text is readable on mobile */
            table.dataTable {
                width: 100% !important;
                border-collapse: collapse;
                font-size: 14px; /* Slightly smaller for mobile */
            }

            /* ðŸ“Œ Adjust column widths for better readability */
            table.dataTable td, table.dataTable th {
                padding: 10px 8px; /* Less padding */
                white-space: nowrap; /* Prevents awkward text wrapping */
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* ðŸ“Œ Ensure name & category don't break badly */
            table.dataTable td:nth-child(1), /* Name */
            table.dataTable td:nth-child(2) { /* Category */
                max-width: 30%; 
            }

            /* ðŸ“Œ Mobile WhatsApp-style view */
            .table-container {
                display: none; /* Hide table on mobile */
            }

            .whatsapp-view {
                display: none; /* Hidden by default, shown on mobile */
            }

            .chat-list {
                margin: 0 -16px;
                padding: 8px 16px;
                background: #fff;
            }

            .chat-item {
                display: flex;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid #e5e5e5;
                text-decoration: none;
                color: inherit;
            }

            .chat-avatar {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                background: #32d296;
                margin-right: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                flex-shrink: 0;
            }

            .chat-content {
                flex-grow: 1;
                min-width: 0; /* Enable text truncation */
            }

            .chat-title {
                font-weight: bold;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .chat-category {
                display: inline-block;
                font-size: 12px;
                padding: 2px 8px;
                border-radius: 12px;
                background: #e8f5e9;
                color: #1b5e20;
                margin-bottom: 4px;
            }

            .chat-preview {
                color: #666;
                font-size: 14px;
                display: -webkit-box;
                display: -moz-box;
                display: box;
                -webkit-line-clamp: 2;
                -moz-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                -moz-box-orient: vertical;
                box-orient: vertical;
                overflow: hidden;
            }

            .chat-phone {
                color: #075e54; /* WhatsApp green */
                font-weight: 500;
                margin-top: 4px;
                display: block;
            }
        }
    </style>    
</head>
<body>

    <div class="uk-container uk-margin-large-top uk-card uk-card-default uk-card-body uk-box-shadow-small" style="max-width: 1000px; padding: 20px;">
        <div class="uk-flex uk-flex-between uk-flex-middle">
            <h2 class="uk-heading-line uk-text-bold uk-margin-small-bottom" style="color: #333;"><span>Resource Directory</span></h2>
            <button id="addEntryBtn" class="uk-button uk-button-primary" style="background-color: #32d296; border-radius: 20px;">Add Entry</button>
        </div>

        <!-- Search Input -->
        <div class="uk-margin-small-bottom">
            <div class="uk-inline uk-width-1-1">
                <span class="uk-form-icon" uk-icon="icon: search"></span>
                <input type="text" id="searchInput" class="uk-input uk-form-large" placeholder="Search by name, category, or description..." style="border-radius: 8px; padding-left: 40px; font-size: 16px;">
            </div>
        </div>

        <!-- Category Filters -->
        <div class="uk-margin-small-bottom filter-section">
            <div class="filter-container">
                <div class="filter-buttons">
                    <!-- Buttons will be dynamically added here -->
                </div>
            </div>
        </div>
        
        <style>
            /* Tighten spacing on mobile */
            @media (max-width: 768px) {
                .filter-section {
                    margin-bottom: 0 !important;
                }
                
                #directoryTable_wrapper {
                    margin-top: 0;
                }
                
                /* Remove extra spacing from table elements */
                .dataTables_wrapper .dataTables_length, 
                .dataTables_wrapper .dataTables_filter, 
                .dataTables_wrapper .dataTables_info, 
                .dataTables_wrapper .dataTables_processing, 
                .dataTables_wrapper .dataTables_paginate {
                    margin-top: 0;
                    margin-bottom: 0;
                    padding-top: 0;
                    padding-bottom: 0;
                }
                
                /* Reduce spacing in table cells */
                table.dataTable tbody td {
                    padding-top: 6px;
                    padding-bottom: 6px;
                }
                
                /* Reduce header spacing */
                table.dataTable thead th {
                    padding-top: 6px;
                    padding-bottom: 6px;
                }
            }
        </style>
        
        <style>
            /* Responsive filter buttons */
            .filter-container {
                display: flex;
                justify-content: center;
                width: 100%;
            }
            
            .filter-buttons {
                display: flex;
                gap: 4px;
                padding: 0 4px;
            }
            
            /* Category button styling */
            .category-btn {
                background-color: #1e87f0;
                color: white;
                border-radius: 20px;
                padding: 6px 14px;
                margin: 3px;
                transition: all 0.2s ease;
                border: none;
                font-size: 14px;
            }
            
            .category-btn:hover {
                background-color: #0f7ae5;
                transform: translateY(-1px);
            }
            
            .category-btn.uk-button-primary {
                background-color: #32d296;
            }
            
            /* On mobile, allow buttons to wrap and adjust button size */
            @media (max-width: 768px) {
                .filter-buttons {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 6px;
                    margin-bottom: 0;
                    width: 100%;
                }
                
                /* Reduce spacing around table */
                .uk-margin-small-bottom {
                    margin-bottom: 0 !important;
                }
                
                /* Reduce container padding */
                .uk-card-body {
                    padding: 12px;
                }
                
                /* Reduce table top margin */
                .uk-grid {
                    margin-top: 0 !important;
                }
                
                .category-btn {
                    padding: 8px 6px;
                    font-size: 12px;
                    min-width: auto;
                    margin: 0;
                    flex-grow: 0;
                    width: 100%;
                    text-overflow: ellipsis;
                    overflow: hidden;
                    white-space: nowrap;
                }
                
                /* Special handling for the All button to make it stand out */
                .filter-buttons .category-btn:first-child {
                    grid-column: span 3;
                    width: 50%;
                    margin: 0 auto;
                }
            }
            
            /* For very small screens, reduce to 2 columns */
            @media (max-width: 480px) {
                .filter-buttons {
                    grid-template-columns: repeat(2, 1fr);
                }
                
                .filter-buttons .category-btn:first-child {
                    grid-column: span 2;
                }
            }
            
            /* On desktop, keep buttons in a single scrollable row */
            @media (min-width: 769px) {
                .filter-container {
                    overflow-x: auto;
                }
                
                .filter-buttons {
                    white-space: nowrap;
                    flex-wrap: nowrap;
                }
            }
        </style>

        <div class="uk-grid uk-grid-small" style="margin-top: 0;">
            <!-- Desktop Table View -->
            <div class="table-view uk-width-1-1">
                <table id="directoryTable" class="uk-table uk-table-striped uk-table-middle display" style="width:100%; margin-top: 0;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Mobile WhatsApp Style View -->
            <div class="whatsapp-view uk-width-1-1">
                <div class="chat-list" id="chatList">
                    <!-- Chat items will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Entry Modal -->
    <div id="add-entry-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <button class="uk-modal-close-default" type="button" uk-close></button>
            <h2 class="uk-modal-title" id="modal-title">Add New Resource</h2>
            <form id="add-entry-form" class="uk-form-stacked">
                <!-- Hidden field for record ID when editing -->
                <input type="hidden" id="form-record-id" value="">
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-name">Name</label>
                    <div class="uk-form-controls">
                        <input class="uk-input" id="form-name" type="text" placeholder="Business or Resource Name" required>
                    </div>
                </div>
                
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-category">Category</label>
                    <div class="uk-form-controls">
                        <select class="uk-select" id="form-category" required>
                            <!-- Categories will be populated dynamically -->
                        </select>
                    </div>
                </div>
                
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-description">Description</label>
                    <div class="uk-form-controls">
                        <textarea class="uk-textarea" id="form-description" rows="3" placeholder="Brief description of services offered" required></textarea>
                    </div>
                </div>
                
                <div class="uk-margin">
                    <label class="uk-form-label" for="form-phone">Phone Number (WhatsApp)</label>
                    <div class="uk-form-controls">
                        <input class="uk-input" id="form-phone" type="tel" placeholder="e.g. 50688123456" required>
                    </div>
                </div>
                
                <div class="uk-margin uk-text-right">
                    <button class="uk-button uk-button-default uk-modal-close" type="button">Cancel</button>
                    <button class="uk-button uk-button-primary" type="submit" id="submit-entry">Submit</button>
                </div>
            </form>
        </div>
    </div>
<script>
        document.addEventListener("DOMContentLoaded", function () {
            const airtableToken = "{{ airtable_token }}";  // Provided by Flask server
            const airtableBaseId = "{{ airtable_base_id }}";  // Provided by Flask server
            const airtableTableName = "{{ airtable_table_name }}";  // Provided by Flask server
            const airtableUrl = `https://api.airtable.com/v0/${airtableBaseId}/${airtableTableName}`;

            fetch(airtableUrl, {
                headers: { "Authorization": `Bearer ${airtableToken}`, "Content-Type": "application/json" }
            })
            .then(response => response.json())
            .then(data => {
                let categories = new Set();
                let categoryMapping = {};

                let records = data.records.map(record => {
                    let category = record.fields["Category"] 
                        ? String(record.fields["Category"]).trim()  
                        : "Uncategorized";  

                    let categoryLower = category.toLowerCase();  
                    categories.add(categoryLower);
                    categoryMapping[categoryLower] = category;

                    let phoneNumber = record.fields["Phone Number"] || "No phone";
                    
                    // âœ… Make phone number clickable for WhatsApp
                    if (phoneNumber !== "No phone") {
                        let cleanNumber = phoneNumber.replace(/\D/g, "");
                        phoneNumber = cleanNumber; // Store clean number for DataTables
                    }
                    
                    return {
                        Name: record.fields["Title"] || "N/A",
                        Category: category,
                        Description: record.fields["Subtitle"] || "No description",
                        Phone: phoneNumber,
                        RecordId: record.id  // Store the record ID for edit/delete operations
                    };
                });

                // DataTable is already initialized above - no need to reinitialize
                
                // Generate category buttons dynamically
                let filterContainer = document.querySelector(".filter-buttons");
                filterContainer.innerHTML = "";  

                // "Show All" button
                let showAllButton = document.createElement("button");
                showAllButton.className = "uk-button uk-button-primary category-button";
                showAllButton.innerText = "All";
                showAllButton.onclick = function () {
                    // Clear both search inputs
                    const customSearchInput = document.getElementById('searchInput');
                    const dtSearchInput = document.querySelector('.dataTables_filter input');
                    
                    // Clear custom search input
                    if (customSearchInput) {
                        customSearchInput.value = '';
                    }
                    
                    // Clear DataTables search and redraw
                    if (dtSearchInput) {
                        dtSearchInput.value = '';
                        table.search('').draw();
                    }
                    
                    // Clear category filter and URL parameters
                    filterCategory(this, "");
                    updateURLAndFilter("", "");
                    
                    // Remove search parameter from URL if it exists
                    const url = new URL(window.location);
                    url.searchParams.delete('search');
                    window.history.replaceState({}, '', url);
                };
                filterContainer.appendChild(showAllButton);

                // Initialize DataTable with minimal styling
                const tableElement = $('#directoryTable');
                table = tableElement.DataTable({
                    data: records,
                    columns: [
                        { data: 'Name' },
                        { data: 'Category' },
                        { data: 'Description' },
                        {
                            data: 'Phone',
                            render: function(data, type, row) {
                                if (type === 'display' && data) {
                                    return `<a href="https://wa.me/${data}" class="chat-phone" target="_blank">
                                            <i class="fab fa-whatsapp"></i>${data}
                                           </a>`;
                                }
                                return data;
                            }
                        },
                        {
                            data: null,
                            defaultContent: '<button class="uk-button uk-button-small uk-button-primary edit-btn"><span uk-icon="pencil"></span></button>',
                            orderable: false,
                            width: '60px'
                        }
                    ],
                    order: [[0, 'asc']],
                    pageLength: 25,
                    dom: 't',
                    language: {
                        search: '',
                        searchPlaceholder: 'Search...'
                    },
                    // Disable all built-in styling
                    autoWidth: false,
                    ordering: true,
                    searching: true,
                    stripe: false,
                    hover: false
                });
                
                // Handle edit button clicks
                $('#directoryTable tbody').on('click', '.edit-btn', function() {
                    const data = table.row($(this).parents('tr')).data();
                    openEditModal(data);
                });
                
                // Function to apply custom styling
                function applyCustomStyling() {
                    // Remove all existing styles
                    $('#directoryTable tbody tr').removeClass('odd even');
                    $('#directoryTable tbody tr td').removeAttr('style').removeAttr('class');
                    
                    // Apply our custom styling
                    $('#directoryTable tbody tr').each(function(index) {
                        // Set background color based on row index
                        const bgColor = index % 2 === 0 ? '#f5f5f5' : '#ffffff';
                        
                        // Apply to the entire row first
                        $(this).css('background-color', bgColor);
                        
                        // Then force each cell to have the same background
                        $(this).find('td').each(function() {
                            $(this).attr('style', 'background-color: ' + bgColor + ' !important');
                        });
                        
                        // Special handling for first column
                        $(this).find('td:first-child').attr('style', 'background-color: ' + bgColor + ' !important; font-weight: 500; color: #1a1a1a;');
                    });
                }
                
                // Apply styling initially and after any DataTable events
                applyCustomStyling();
                table.on('draw', applyCustomStyling);
                table.on('page', applyCustomStyling);
                table.on('order', applyCustomStyling);

                // Category filtering function
                function filterByCategory(category) {
                    const buttons = document.querySelectorAll('.filter-buttons .category-btn');
                    buttons.forEach(btn => {
                        if (btn.textContent === category) {
                            btn.classList.add('uk-button-primary');
                        } else {
                            btn.classList.remove('uk-button-primary');
                        }
                    });

                    table.column(1).search(category === 'All' ? '' : category).draw();

                    const url = new URL(window.location);
                    if (category === 'All') {
                        url.searchParams.delete('category');
                    } else {
                        url.searchParams.set('category', category);
                    }
                    window.history.pushState({}, '', url);
                }

                // Create and initialize category buttons
                const uniqueCategories = [...new Set(records.map(record => record.Category))];
                uniqueCategories.sort();

                const filterButtons = document.querySelector('.filter-buttons');
                filterButtons.innerHTML = '';
                
                // Add All button first
                const allButton = document.createElement('button');
                allButton.className = 'uk-button uk-button-primary category-btn';
                allButton.textContent = 'All';
                allButton.addEventListener('click', () => filterByCategory('All'));
                filterButtons.appendChild(allButton);

                // Add other category buttons
                uniqueCategories.forEach(category => {
                    const button = document.createElement('button');
                    button.className = 'uk-button category-btn';
                    button.textContent = category;
                    button.addEventListener('click', () => filterByCategory(category));
                    filterButtons.appendChild(button);
                });

                // Check URL for initial category filter
                const urlParams = new URLSearchParams(window.location.search);
                const initialCategory = urlParams.get('category') || 'All';
                if (initialCategory !== 'All') {
                    filterByCategory(initialCategory);
                }

                // Initialize search functionality
                $('#searchInput').on('keyup', function() {
                    table.search(this.value).draw();
                });

                // âœ… Populate WhatsApp style view
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = ''; // Clear existing items

                // Populate mobile chat view
                function populateChatList(records) {
                    const chatList = document.getElementById('chatList');
                    chatList.innerHTML = ''; // Clear existing items

                    records.forEach(record => {
                        const phoneNumber = record.Phone ? record.Phone.replace(/[^0-9]/g, '') : '';
                        const initial = record.Name ? record.Name.charAt(0).toUpperCase() : '?';
                        const chatItem = document.createElement('a');
                        chatItem.href = phoneNumber ? `https://wa.me/${phoneNumber}` : '#';
                        chatItem.className = 'chat-item';
                        chatItem.innerHTML = `
                            <div class="chat-avatar">${initial}</div>
                            <div class="chat-content">
                                <div class="chat-title">${record.Name || 'Unknown'}</div>
                                <div class="chat-category">${record.Category || 'Uncategorized'}</div>
                                <div class="chat-preview">${record.Description || 'No description available'}</div>
                                ${record.Phone ? `<div class="chat-phone"><i class="fab fa-whatsapp"></i>${record.Phone}</div>` : ''}
                            </div>
                        `;
                        chatList.appendChild(chatItem);
                    });
                }

                // Initial population of chat list
                populateChatList(records);

                // Update mobile view when table is filtered
                table.on('search.dt', function() {
                    const filteredData = table.rows({ search: 'applied' }).data().toArray();
                    populateChatList(filteredData);
                });

                // Handle mobile/desktop view switching
                function toggleViews() {
                    const isMobile = window.innerWidth <= 768;
                    document.querySelector('.table-view').style.display = isMobile ? 'none' : 'block';
                    document.querySelector('.whatsapp-view').style.display = isMobile ? 'block' : 'none';
                }

                // Initial check and listen for resize
                toggleViews();
                window.addEventListener('resize', toggleViews);

                // âœ… Function to update URL and apply filtering
                function updateURLAndFilter(category, searchTerm) {
                    let params = new URLSearchParams(window.location.search);

                    // Update category filter
                    if (category !== null) {
                        if (category === "") {
                            params.delete("category");
                            table.column(1).search("", false, false).draw();
                        } else {
                            params.set("category", category);
                            table.column(1).search("^" + $.fn.dataTable.util.escapeRegex(category) + "$", true, false).draw();
                        }
                    }

                    // Update search term
                    if (searchTerm !== null) {
                        if (searchTerm === "") {
                            params.delete("search");
                        } else {
                            params.set("search", searchTerm);
                        }
                        table.search(searchTerm).draw();
                    }

                    // Update URL without adding empty parameters
                    const urlParams = params.toString();
                    history.pushState({}, "", urlParams ? "?" + urlParams : window.location.pathname);
                }

                // âœ… Handle Search Input Updates URL
                document.getElementById("searchInput").addEventListener("keyup", function () {
                    updateURLAndFilter(null, this.value);
                });

                // âœ… On Page Load, Apply URL Filters
                function applyURLFilters() {
                    let params = new URLSearchParams(window.location.search);
                    let category = params.get("category");
                    let searchTerm = params.get("search");

                    if (category) {
                        if (category === "") {
                            table.column(1).search("").draw(); // âœ… Ensure "Show All" works
                        } else {
                            table.column(1).search(`^${category}$`, true, false).draw();
                        }
                        // Find and highlight the button for this category
                        let categoryButton = [...document.querySelectorAll(".category-button")]
                            .find(button => button.innerText.toLowerCase() === category.toLowerCase());
                        if (categoryButton) {
                            filterCategory(categoryButton, categoryButton.innerText, false);
                        }
                    }

                    if (searchTerm) {
                        document.getElementById("searchInput").value = searchTerm;
                        table.search(searchTerm).draw();
                    }
                }

                // âœ… Handle category filtering and button styling
                function filterCategory(button, category, updateState = true) {
                    // Reset all buttons to primary (blue) style
                    document.querySelectorAll(".category-button").forEach(btn => {
                        btn.classList.remove("category-selected");
                    });

                    // Add selected class to highlight the clicked button
                    button.classList.add("category-selected");

                    // Update URL and filter table if needed
                    if (updateState) {
                        updateURLAndFilter(category, null);
                    }
                }

                applyURLFilters(); 
                
                // Populate the category dropdown in the Add Entry form
                const categorySelect = document.getElementById('form-category');
                categorySelect.innerHTML = '';
                
                // Add a default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a category';
                categorySelect.appendChild(defaultOption);
                
                // Use actual categories from Airtable
                // This ensures we use exactly the same category values that exist in Airtable
                const existingCategories = [...categories].map(cat => categoryMapping[cat]);
                existingCategories.sort();
                
                existingCategories.forEach(category => {
                    if (category) { // Skip empty categories
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    }
                });
                
                // Function to open the modal for editing
                function openEditModal(data) {
                    // Set modal title
                    document.getElementById('modal-title').textContent = 'Edit Resource';
                    
                    // Store record ID
                    document.getElementById('form-record-id').value = data.RecordId;
                    
                    // Populate form fields
                    document.getElementById('form-name').value = data.Name === 'N/A' ? '' : data.Name;
                    
                    // For the category dropdown, find and select the right option
                    const categorySelect = document.getElementById('form-category');
                    for (let i = 0; i < categorySelect.options.length; i++) {
                        if (categorySelect.options[i].value === data.Category) {
                            categorySelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    document.getElementById('form-description').value = 
                        data.Description === 'No description' ? '' : data.Description;
                    document.getElementById('form-phone').value = 
                        data.Phone === 'No phone' ? '' : data.Phone;
                    
                    // Change submit button text
                    document.getElementById('submit-entry').textContent = 'Save Changes';
                    
                    // Show the modal
                    UIkit.modal('#add-entry-modal').show();
                }
                
                // Function to reset the modal for adding a new entry
                function resetModalForAdd() {
                    // Set modal title
                    document.getElementById('modal-title').textContent = 'Add New Resource';
                    
                    // Clear record ID
                    document.getElementById('form-record-id').value = '';
                    
                    // Clear form fields
                    document.getElementById('form-name').value = '';
                    document.getElementById('form-category').selectedIndex = 0;
                    document.getElementById('form-description').value = '';
                    document.getElementById('form-phone').value = '';
                    
                    // Reset submit button text
                    document.getElementById('submit-entry').textContent = 'Submit';
                }
                
                // Set up the Add Entry button to open the modal for adding
                document.getElementById('addEntryBtn').addEventListener('click', function() {
                    resetModalForAdd();
                    UIkit.modal('#add-entry-modal').show();
                });
                
                // Make sure the modal is reset when it's closed
                UIkit.util.on('#add-entry-modal', 'hidden', function() {
                    resetModalForAdd();
                });
                
                // Handle form submission
                document.getElementById('add-entry-form').addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const submitBtn = document.getElementById('submit-entry');
                    const category = document.getElementById('form-category').value;
                    const title = document.getElementById('form-name').value;
                    const recordId = document.getElementById('form-record-id').value;
                    const isEdit = !!recordId;
                    
                    // Validate required fields
                    if (!title.trim()) {
                        UIkit.notification({
                            message: 'Title is required',
                            status: 'danger',
                            pos: 'top-center',
                            timeout: 3000
                        });
                        return;
                    }
                    
                    if (!category) {
                        UIkit.notification({
                            message: 'Please select a category',
                            status: 'danger',
                            pos: 'top-center',
                            timeout: 3000
                        });
                        return;
                    }
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEdit ? 'Saving...' : 'Submitting...';
                    
                    // Ensure we're using the correct field names that match the Airtable schema
                    // For Category, use an array since it's a Multiple Select field in Airtable
                    const formData = {
                        fields: {
                            "Title": title.trim(),
                            "Category": [category], // Put category in an array for Multiple Select field
                            "Subtitle": document.getElementById('form-description').value.trim(),
                            "Phone Number": document.getElementById('form-phone').value.trim()
                        }
                    };
                    
                    // If editing, add the record ID
                    if (isEdit) {
                        formData.record_id = recordId;
                    }
                    
                    console.log(`Sending ${isEdit ? 'update' : 'add'} data:`, formData);
                    
                    // Determine which endpoint to use
                    const endpoint = isEdit ? '/update_directory_entry' : '/add_directory_entry';
                    
                    // Submit to our backend route which will forward to Airtable
                    fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(formData)
                    })
                    .then(async response => {
                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.error || 'Network response was not ok');
                        }
                        return data;
                    })
                    .then(data => {
                        // Get the phone number in the correct format for display
                        const phoneNumber = formData.fields["Phone Number"] ? 
                            formData.fields["Phone Number"] : 'No phone';
                            
                        // Create record object for the table
                        const updatedRecord = {
                            Name: formData.fields["Title"],
                            Category: formData.fields["Category"][0], // First item from category array
                            Description: formData.fields["Subtitle"] || "No description",
                            Phone: phoneNumber,
                            RecordId: isEdit ? recordId : (data.data?.id || '') // Use existing ID or get from response
                        };
                        
                        if (isEdit) {
                            // Find the row with matching record ID and update it
                            const rowIndex = table.rows().indexes().filter(idx => {
                                const rowData = table.row(idx).data();
                                return rowData.RecordId === recordId;
                            });
                            
                            if (rowIndex.length > 0) {
                                table.row(rowIndex[0]).data(updatedRecord).draw(false);
                            }
                            
                            // Show success notification for update
                            UIkit.notification({
                                message: `Successfully updated ${formData.fields["Title"]}!`,
                                status: 'success',
                                pos: 'top-center',
                                timeout: 3000
                            });
                        } else {
                            // Add new row for a new entry
                            table.row.add(updatedRecord).draw(false);
                            
                            // Show success notification for new entry
                            UIkit.notification({
                                message: `Successfully added ${formData.fields["Title"]} to the directory!`,
                                status: 'success',
                                pos: 'top-center',
                                timeout: 3000
                            });
                        }
                        
                        // Close modal and reset the form
                        UIkit.modal('#add-entry-modal').hide();
                        
                        // Apply any custom styling needed
                        if (typeof applyCustomStyling === 'function') {
                            applyCustomStyling();
                        }
                        
                        // Reset submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit';
                    })
                    .catch(error => {
                        console.error(`Error ${isEdit ? 'updating' : 'adding'} entry:`, error);
                        
                        // Attempt to parse error message from JSON response if possible
                        let errorMessage = error.message;
                        
                        // For more specific error messages when available
                        if (errorMessage.includes('JSON') || errorMessage.includes('Unexpected token')) {
                            errorMessage = 'Server error. Please check if all Airtable credentials are set in the .env file.';
                        }
                        
                        // Show error notification with more specific message
                        UIkit.notification({
                            message: errorMessage || `Failed to ${isEdit ? 'update' : 'add'} entry. Please check your input and try again.`,
                            status: 'danger',
                            pos: 'top-center',
                            timeout: 5000
                        });
                    })
                    .finally(() => {
                        // Reset submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = isEdit ? 'Save Changes' : 'Submit';
                    });
                });
            })
            .catch(error => console.error("Error fetching Airtable data:", error));
        });
</script>



</body>
</html>

